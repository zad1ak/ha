blueprint:
  name: "Quiet Mode Trigger"
  description: >
    Ð£Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¸Ð½Ñ‚ÐµÐ»Ð»ÐµÐºÑ‚ÑƒÐ°Ð»ÑŒÐ½Ñ‹Ð¼ "Ð¢Ð¸Ñ…Ð¸Ð¼ Ñ€ÐµÐ¶Ð¸Ð¼Ð¾Ð¼". ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÑ‚ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ñ Ð² Android Ð¸ Telegram,
    Ð²ÐºÐ»ÑŽÑ‡Ð°ÐµÑ‚ Ñ†Ð¸ÐºÐ» Ð¾Ñ‚Ð»Ð¾Ð¶ÐµÐ½Ð½Ñ‹Ñ… ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ð¹, Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ Ð·Ð°Ð¿ÑƒÑÐºÐ°ÐµÑ‚ Blueprint Executor.
  domain: automation
  input:
    start_time:
      name: "Ð’Ñ€ÐµÐ¼Ñ Ð½Ð°Ñ‡Ð°Ð»Ð°"
      description: "Ð’Ñ€ÐµÐ¼Ñ, ÐºÐ¾Ð³Ð´Ð° Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÑ‚ÑÑ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ðµ Ð¾ Ñ‚Ð¸Ñ…Ð¾Ð¼ Ñ€ÐµÐ¶Ð¸Ð¼Ðµ"
      selector:
        time: {}
    end_time:
      name: "Ð’Ñ€ÐµÐ¼Ñ Ð¾ÐºÐ¾Ð½Ñ‡Ð°Ð½Ð¸Ñ"
      description: "Ð’Ñ€ÐµÐ¼Ñ, Ð´Ð¾ ÐºÐ¾Ñ‚Ð¾Ñ€Ð¾Ð³Ð¾ Ð´ÐµÐ¹ÑÑ‚Ð²ÑƒÐµÑ‚ Ñ‚Ð¸Ñ…Ð¸Ð¹ Ñ€ÐµÐ¶Ð¸Ð¼ Ð¸ Ð¿Ð¾Ð²Ñ‚Ð¾Ñ€ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ð¹"
      default: "07:00"
      selector:
        time: {}
    quiet_devices:
      name: "Ð“Ñ€ÑƒÐ¿Ð¿Ð° ÑƒÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð² Ð´Ð»Ñ Ñ‚Ð¸Ñ…Ð¾Ð³Ð¾ Ñ€ÐµÐ¶Ð¸Ð¼Ð°"
      description: "Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ ÑƒÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²Ð°, Ð½Ð° ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ðµ Ð±ÑƒÐ´ÐµÑ‚ Ð²Ð»Ð¸ÑÑ‚ÑŒ Ñ‚Ð¸Ñ…Ð¸Ð¹ Ñ€ÐµÐ¶Ð¸Ð¼ (ÐºÐ¾Ð»Ð¾Ð½ÐºÐ¸, Ð¢Ð’, ÑÐ²ÐµÑ‚, ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ñ)"
      selector:
        entity:
          domain: group
    volume_percent:
      name: "Ð“Ñ€Ð¾Ð¼ÐºÐ¾ÑÑ‚ÑŒ (Ð¿Ñ€Ð¾Ñ†ÐµÐ½Ñ‚Ñ‹)"
      description: "ÐŸÑ€Ð¾Ñ†ÐµÐ½Ñ‚Ð½Ð°Ñ Ð³Ñ€Ð¾Ð¼ÐºÐ¾ÑÑ‚ÑŒ, ÐµÑÐ»Ð¸ Ð²Ñ‹Ð±Ñ€Ð°Ð½ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚ Ð¿Ñ€Ð¾Ñ†ÐµÐ½Ñ‚Ð¾Ð²"
      default: 10
      selector:
        number:
          min: 1
          max: 100
          step: 1
    volume_level:
      name: "Ð“Ñ€Ð¾Ð¼ÐºÐ¾ÑÑ‚ÑŒ (ÑƒÑ€Ð¾Ð²ÐµÐ½ÑŒ 0â€“1)"
      description: "Ð£Ñ€Ð¾Ð²ÐµÐ½ÑŒ Ð³Ñ€Ð¾Ð¼ÐºÐ¾ÑÑ‚Ð¸ Ð´Ð»Ñ Ð¼ÐµÐ´Ð¸Ð°Ð¿Ð»ÐµÐµÑ€Ð¾Ð², ÐµÑÐ»Ð¸ Ð²Ñ‹Ð±Ñ€Ð°Ð½ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚ 0â€“1"
      default: 0.1
      selector:
        number:
          min: 0.0
          max: 1.0
          step: 0.01
    use_percent:
      name: "Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ Ð¿Ñ€Ð¾Ñ†ÐµÐ½Ñ‚Ñ‹?"
      description: "Ð•ÑÐ»Ð¸ Ð²ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¾, Ð³Ñ€Ð¾Ð¼ÐºÐ¾ÑÑ‚ÑŒ Ð±ÐµÑ€Ñ‘Ñ‚ÑÑ Ð¸Ð· volume_percent; Ð¸Ð½Ð°Ñ‡Ðµ Ð¸Ð· volume_level"
      default: true
      selector:
        boolean: {}
    android_device:
      name: "Android ÑƒÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²Ð¾"
      description: "Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ ÑƒÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²Ð¾ Ð´Ð»Ñ push ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ð¹"
      selector:
        device:
          integration: mobile_app
    telegram_chat_id:
      name: "Telegram Chat ID"
      description: "Chat ID Ð´Ð»Ñ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¸ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ð¹ Ð² Telegram"
      selector:
        text: {}
    text_style:
      name: "Ð¡Ñ‚Ð¸Ð»ÑŒ Ñ‚ÐµÐºÑÑ‚Ð° ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ð¹"
      description: "Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ñ„Ð¾Ñ€Ð¼Ð°Ð»ÑŒÐ½Ñ‹Ð¹, Ð´Ñ€ÑƒÐ¶ÐµÐ»ÑŽÐ±Ð½Ñ‹Ð¹, ÑÑ‚Ñ€Ð¾Ð³Ð¸Ð¹ Ð¸Ð»Ð¸ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒÑÐºÐ¸Ð¹ Ñ‚ÐµÐºÑÑ‚"
      default: "friendly"
      selector:
        select:
          options:
            - formal
            - friendly
            - strict
            - custom
    custom_text:
      name: "ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒÑÐºÐ¸Ð¹ Ñ‚ÐµÐºÑÑ‚"
      description: "Ð¢ÐµÐºÑÑ‚ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ñ, ÐµÑÐ»Ð¸ Ð²Ñ‹Ð±Ñ€Ð°Ð½ ÑÑ‚Ð¸Ð»ÑŒ 'custom'. Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ÑÑ Ð´Ð»Ñ push, Telegram Ð¸ TTS ÐÐ»Ð¸ÑÑ‹"
      default: "ÐÐ»ÐµÐºÑÐµÐ¹, Ð²ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒ Ñ‚Ð¸Ñ…Ð¸Ð¹ Ñ€ÐµÐ¶Ð¸Ð¼?"
      selector:
        text: {}
    response_timeout:
      name: "Ð¢Ð°Ð¹Ð¼ÐµÑ€ Ð¾Ð¶Ð¸Ð´Ð°Ð½Ð¸Ñ Ð¾Ñ‚Ð²ÐµÑ‚Ð°"
      description: "Ð’Ñ€ÐµÐ¼Ñ Ð² Ð¼Ð¸Ð½ÑƒÑ‚Ð°Ñ…, Ð¿Ð¾ÑÐ»Ðµ ÐºÐ¾Ñ‚Ð¾Ñ€Ð¾Ð³Ð¾ Ñ‚Ð¸Ñ…Ð¸Ð¹ Ñ€ÐµÐ¶Ð¸Ð¼ Ð²ÐºÐ»ÑŽÑ‡Ð°ÐµÑ‚ÑÑ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸, ÐµÑÐ»Ð¸ Ð½ÐµÑ‚ Ð¾Ñ‚Ð²ÐµÑ‚Ð°"
      default: 10
      selector:
        number:
          min: 1
          max: 60
          step: 1
    delay_options:
      name: "Ð’Ð°Ñ€Ð¸Ð°Ð½Ñ‚Ñ‹ Ð¾Ñ‚Ð»Ð¾Ð¶Ð¸Ñ‚ÑŒ (Ð¼Ð¸Ð½ÑƒÑ‚Ñ‹)"
      description: "Ð¡ÐºÐ¾Ð»ÑŒÐºÐ¾ Ð¼Ð¸Ð½ÑƒÑ‚ Ð¼Ð¾Ð¶Ð½Ð¾ Ð¾Ñ‚Ð»Ð¾Ð¶Ð¸Ñ‚ÑŒ Ñ‚Ð¸Ñ…Ð¸Ð¹ Ñ€ÐµÐ¶Ð¸Ð¼ Ñ‡ÐµÑ€ÐµÐ· ÐºÐ½Ð¾Ð¿ÐºÑƒ"
      default:
        - 30
        - 60
        - 120
      selector:
        object:
          multiple: true
          mapping:
            30: "30 Ð¼Ð¸Ð½ÑƒÑ‚"
            60: "1 Ñ‡Ð°Ñ"
            120: "2 Ñ‡Ð°ÑÐ°"
trigger:
  - platform: time
    at: !input start_time
action:
  - variables:
      message_text: >
        {% if is_state(input.text_style, 'custom') %}
          {{ input.custom_text }}
        {% elif is_state(input.text_style, 'formal') %}
          "ÐÐ»ÐµÐºÑÐµÐ¹, ÑÐµÐ¹Ñ‡Ð°Ñ {{now().strftime('%H:%M')}}. Ð’ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒ Ñ‚Ð¸Ñ…Ð¸Ð¹ Ñ€ÐµÐ¶Ð¸Ð¼?"
        {% elif is_state(input.text_style, 'strict') %}
          "Ð’Ñ€ÐµÐ¼Ñ {{now().strftime('%H:%M')}}. ÐÐºÑ‚Ð¸Ð²Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ñ‚Ð¸Ñ…Ð¸Ð¹ Ñ€ÐµÐ¶Ð¸Ð¼."
        {% else %}
          "ÐÐ»ÐµÐºÑÐµÐ¹, ÑƒÐ¶Ðµ Ð¿Ð¾Ð·Ð´Ð½Ð¾. Ð’ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒ Ñ‚Ð¸Ñ…Ð¸Ð¹ Ñ€ÐµÐ¶Ð¸Ð¼? ðŸ™‚"
        {% endif %}
  - service: notify.mobile_app_{{ input.android_device }}
    data:
      title: "Ð¢Ð¸Ñ…Ð¸Ð¹ Ñ€ÐµÐ¶Ð¸Ð¼"
      message: "{{ message_text }}"
      data:
        actions:
          - action: QUIET_MODE_START
            title: "Ð’ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒ"
          - action: QUIET_MODE_DELAY_30
            title: "ÐžÑ‚Ð»Ð¾Ð¶Ð¸Ñ‚ÑŒ 30 Ð¼Ð¸Ð½"
          - action: QUIET_MODE_DELAY_60
            title: "ÐžÑ‚Ð»Ð¾Ð¶Ð¸Ñ‚ÑŒ 1 Ñ‡Ð°Ñ"
          - action: QUIET_MODE_DELAY_120
            title: "ÐžÑ‚Ð»Ð¾Ð¶Ð¸Ñ‚ÑŒ 2 Ñ‡Ð°ÑÐ°"
  - service: telegram_bot.send_message
    data:
      target: !input telegram_chat_id
      message: "{{ message_text }}"
      inline_keyboard:
        - "Ð’ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒ:quiet_mode_start,ÐžÑ‚Ð»Ð¾Ð¶Ð¸Ñ‚ÑŒ 30 Ð¼Ð¸Ð½:quiet_mode_delay_30"
        - "ÐžÑ‚Ð»Ð¾Ð¶Ð¸Ñ‚ÑŒ 1 Ñ‡Ð°Ñ:quiet_mode_delay_60,ÐžÑ‚Ð»Ð¾Ð¶Ð¸Ñ‚ÑŒ 2 Ñ‡Ð°ÑÐ°:quiet_mode_delay_120"
  - wait_for_trigger:
      - platform: event
        event_type: mobile_app_notification_action
      timeout: "{{ input.response_timeout | int * 60 }}"
  - choose:
      - conditions:
          - condition: template
            value_template: "{{ wait.trigger.event.data.action == 'QUIET_MODE_START' }}"
        sequence:
          - service: automation.trigger
            target:
              entity_id: automation.quiet_mode_executor
      - conditions:
          - condition: template
            value_template: "{{ wait.trigger.event.data.action in ['QUIET_MODE_DELAY_30','QUIET_MODE_DELAY_60','QUIET_MODE_DELAY_120'] }}"
        sequence:
          - service: script.quiet_mode_delay_handler
            data:
              delay_minutes: >
                {% if wait.trigger.event.data.action == 'QUIET_MODE_DELAY_30' %}30
                {% elif wait.trigger.event.data.action == 'QUIET_MODE_DELAY_60' %}60
                {% else %}120{% endif %}
