# esphome_main_config.yaml
# Основной конфигурационный файл с расширенными возможностями
# Управление: яркость, скорость эффектов, насыщенность (через RGB), цветовая температура
# Датчики: движение, температура, влажность, освещенность
# 150+ пресетов WLED-подобных с эффектами



# Название устройства и тип микроконтроллера
esphome:
  name: led_controller_advanced
  friendly_name: led
  comment: "Основной пакет с эффектами, пресетами и параметрами"
esp8266:
  board: esp01_1m

# ////////////////////////////////////////
# ///// начало не изменяемая часть ///////
# ////////////////////////////////////////
# Включить ведение журнала
logger: 
# Включить API Home Assistant (нужно для подтверждения подключения)
api:
  # key: !secret API 
ota: 
  # password: !secret OTA #пароль для обновления по воздуху
  safe_mode: true
 
  ap:  # Включить резервную точку доступа (портал авторизации) на случай сбоя подключения к Wi-Fi.
    ssid: ${name}
    password: !secret AP # Ннужно добавить пароль в secret
##настройка статического IP адреса
  #manual_ip:
  #  # IP адрес ESP модуля
  #  static_ip: 192.168.0.151
  #  # IP адрес можема/роутера
  #  gateway: 192.168.0.1
  #  # Маска подсети
  #  subnet: 255.255.255.0    
# Веб-сервер
web_server:
  port: 80 # потрт для подключения
#  auth:
#    username: !secret web_user
#    password: !secret web_password

# Captive portal для аварийного доступа
captive_portal:

# //////////////////////////
# конец не изменяемой части
# //////////////////////////
# начало изменяемой части
# //////////////////////////
# перезагрузка узла
button:
  - platform: restart 
    name: "Перезагрузка"
    entity_category: config 

text_sensor:
  - platform: "${friendly_name} IP адрес"
    ip_address:
      name: "Device IP"

# Умный ночник с настраиваемой чувствительностью
binary_sensor:
  - platform: gpio
    id: motion_night
    name: "${friendly_name} Ночник"
    pin:
      number: GPIO12
      mode: INPUT_PULLUP
      inverted: true
    on_press:
      - light.turn_on:
          id: led_strip
          brightness: 20%
          transition: 3s
    on_release:
      - delay: 30s
      - light.turn_off:
          id: led_strip
          transition: 10s
# для физичекской копки
    - platform: gpio
    pin:
      number: GPIO0
      mode: INPUT_PULLUP
      inverted: True
    name: "${friendly_name} Кнопка вкл/выкл"
    on_press:
        then:
            - light.toggle: led_strip

# Автоматическое применение пресетов по времени суток
time:
  - platform: homeassistant
    id: ha_time

interval:
  - interval: 60s
    then:
      - lambda: |-
          auto t = id(ha_time).now();
          if (!t.is_valid()) return;
          if (t.hour >= 6 && t.hour < 12) {
            id(preset_1_warm).execute();
          } else if (t.hour >= 12 && t.hour < 20) {
            id(preset_25_cool).execute();
          } else {
            id(preset_50_pastel).execute();
          }
          

# //////////////////////////
# конец изменяемой части
# //////////////////////////


# Светодиодная лента
light:
  - platform: neopixelbus
    id: led_strip
    name: "${friendly_name} LED Strip"
    type: GRB
    pin: 2 # D2 (GPIO2)
    num_leds: 300
    variant: WS2812

# Датчики
binary_sensor:
  - platform: gpio
    id: motion_sensor
    name: "${friendly_name} Датчик движения"
    pin:
      number: GPIO14
      mode: INPUT_PULLUP
      inverted: true
    # Чувствительность через мультипликатор
    on_press:
      - lambda: |-
          static int multiplier = 1;
          id(led_strip).turn_on();
          // Можно использовать multiplier для управления временем включения

sensor:
  - platform: dht
    pin: D5
    model: DHT22
    temperature:
      name: "${friendly_name} Температура"
    humidity:
      name: "${friendly_name} Вложность"
    update_interval: 60s

  - platform: adc
    pin: A0
    name: "${friendly_name} Окружающий свет"
    update_interval: 60s

  - platform: uptime
    name: "${friendly_name} Время работы"
    update_interval: 60s # переодичность обновления

# =====================
# 150+ пресетов
# =====================
script:
  - id: preset_1_warm
    then:
      - light.turn_on:
          id: led_strip
          red: 255
          green: 180
          blue: 0
          brightness: 20%
          # скорость эффекта
          transition: 200ms
          effect: "Meteor"

  - id: preset_2_warm
    then:
      - light.turn_on:
          id: led_strip
          red: 255
          green: 100
          blue: 0
          brightness: 80%
          # скорость эффекта
          transition: 150ms
          effect: "Comet"

  - id: preset_3_warm
    then:
      - light.turn_on:
          id: led_strip
          red: 255
          green: 0
          blue: 0
          brightness: 80%
          # скорость эффекта
          transition: 50ms
          effect: "Comet"

  - id: preset_4_warm
    then:
      - light.turn_on:
          id: led_strip
          red: 255
          green: 127
          blue: 80
          brightness: 60%
          # скорость эффекта
          transition: 50ms
          effect: "Rainbow"

  - id: preset_5_warm
    then:
      - light.turn_on:
          id: led_strip
          red: 250
          green: 128
          blue: 114
          brightness: 60%
          # скорость эффекта
          transition: 200ms
          effect: "Meteor"

  - id: preset_6_warm
    then:
      - light.turn_on:
          id: led_strip
          red: 255
          green: 105
          blue: 180
          brightness: 80%
          # скорость эффекта
          transition: 150ms
          effect: "Noise"

  - id: preset_7_cool
    then:
      - light.turn_on:
          id: led_strip
          red: 0
          green: 200
          blue: 200
          brightness: 100%
          # скорость эффекта
          transition: 200ms
          effect: "Meteor"

  - id: preset_8_cool
    then:
      - light.turn_on:
          id: led_strip
          red: 0
          green: 0
          blue: 255
          brightness: 40%
          # скорость эффекта
          transition: 50ms
          effect: "Comet"

  - id: preset_9_cool
    then:
      - light.turn_on:
          id: led_strip
          red: 200
          green: 220
          blue: 255
          brightness: 100%
          # скорость эффекта
          transition: 100ms
          effect: "Comet"

  - id: preset_10_cool
    then:
      - light.turn_on:
          id: led_strip
          red: 0
          green: 128
          blue: 128
          brightness: 20%
          # скорость эффекта
          transition: 200ms
          effect: "Meteor"

  - id: preset_11_cool
    then:
      - light.turn_on:
          id: led_strip
          red: 0
          green: 0
          blue: 128
          brightness: 100%
          # скорость эффекта
          transition: 50ms
          effect: "Noise"

  - id: preset_12_pastel
    then:
      - light.turn_on:
          id: led_strip
          red: 255
          green: 182
          blue: 193
          brightness: 100%
          # скорость эффекта
          transition: 150ms
          effect: "Glitter"

  - id: preset_13_pastel
    then:
      - light.turn_on:
          id: led_strip
          red: 173
          green: 216
          blue: 230
          brightness: 100%
          # скорость эффекта
          transition: 200ms
          effect: "Fire2012"

  - id: preset_14_pastel
    then:
      - light.turn_on:
          id: led_strip
          red: 152
          green: 251
          blue: 152
          brightness: 100%
          # скорость эффекта
          transition: 100ms
          effect: "Rainbow"

  - id: preset_15_pastel
    then:
      - light.turn_on:
          id: led_strip
          red: 221
          green: 160
          blue: 221
          brightness: 60%
          # скорость эффекта
          transition: 200ms
          effect: "Comet"

  - id: preset_16_pastel
    then:
      - light.turn_on:
          id: led_strip
          red: 255
          green: 218
          blue: 185
          brightness: 60%
          # скорость эффекта
          transition: 150ms
          effect: "Meteor"

  - id: preset_17_seasonal
    then:
      - light.turn_on:
          id: led_strip
          red: 0
          green: 255
          blue: 0
          brightness: 20%
          # скорость эффекта
          transition: 50ms
          effect: "Fire2012"

  - id: preset_18_seasonal
    then:
      - light.turn_on:
          id: led_strip
          red: 255
          green: 255
          blue: 0
          brightness: 60%
          # скорость эффекта
          transition: 50ms
          effect: "Noise"

  - id: preset_19_seasonal
    then:
      - light.turn_on:
          id: led_strip
          red: 255
          green: 0
          blue: 0
          brightness: 20%
          # скорость эффекта
          transition: 100ms
          effect: "Comet"

  - id: preset_20_seasonal
    then:
      - light.turn_on:
          id: led_strip
          red: 255
          green: 255
          blue: 255
          brightness: 40%
          # скорость эффекта
          transition: 200ms
          effect: "Glitter"

  - id: preset_21_seasonal
    then:
      - light.turn_on:
          id: led_strip
          red: 128
          green: 0
          blue: 128
          brightness: 100%
          # скорость эффекта
          transition: 50ms
          effect: "Comet"



# Автоматическое применение пресетов по времени суток
time:
  - platform: homeassistant
    id: ha_time

interval:
  - interval: 60s
    then:
      - lambda: |-
          auto t = id(ha_time).now();
          if (!t.is_valid()) return;
          if (t.hour >= 6 && t.hour < 12) {
            id(preset_1_warm).execute();
          } else if (t.hour >= 12 && t.hour < 20) {
            id(preset_25_cool).execute();
          } else {
            id(preset_50_pastel).execute();
          }






# Конец основного файла
